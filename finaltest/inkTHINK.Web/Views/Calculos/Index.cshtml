@model IEnumerable<inkTHINK.Domain.Entities.Calculo>
@using System.Globalization

<h1>Cálculos Realizados</h1>

<table class="table table-hover">
    <thead>
        <tr>
            <th>Id</th>
            <th>Contribuyente</th>
            <th>Monto</th>
            <th>Impuesto Calculado</th>
            <th>Detalle de impuestos</th>
            <th>Fecha</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var calc in Model)
        {
            <tr>
                <td>@calc.Id</td>
                <td>@calc.Contribuyente?.Nombre</td>
                <td>@calc.Monto.ToString("N2", CultureInfo.CurrentCulture)</td>
                <td>@calc.ImpuestoCalculado.ToString("N2", CultureInfo.CurrentCulture)</td>
                <td>
                    @{
                        var detalle = new Dictionary<string, decimal>();
                        if (!string.IsNullOrWhiteSpace(calc.DetalleImpuestosJson))
                        {
                            detalle = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, decimal>>(calc.DetalleImpuestosJson)
                                     ?? new Dictionary<string, decimal>();
                        }
                    }
                    <ul>
                        @foreach (var d in detalle)
                        {
                            <li>@d.Key: @d.Value.ToString("N2", CultureInfo.CurrentCulture)</li>
                        }
                    </ul>
                </td>
                <td>@calc.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                <td>
                    <a asp-action="Edit" asp-route-id="@calc.Id" class="btn btn-sm btn-warning">Editar</a>
                    <a asp-action="Delete" asp-route-id="@calc.Id" class="btn btn-sm btn-danger"
                       onclick="return confirm('¿Está seguro de eliminar este cálculo?');">Eliminar</a>
                </td>
            </tr>
        }
    </tbody>
</table>

<h2>Nuevo Cálculo</h2>

<form asp-action="Create" method="post">
    <div class="mb-3">
        <label>Contribuyente</label>
        <select name="contribuyenteId" class="form-select" required>
            <option value="">-- Seleccione un contribuyente --</option>
            @if (ViewBag.Contribuyentes != null)
            {
                foreach (var c in ViewBag.Contribuyentes)
                {
                    <option value="@c.Id">@c.Nombre</option>
                }
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Monto</label>
        <input type="number" step="0.01" name="monto" class="form-control" required />
    </div>

    <div class="mb-3">
        <label>Reglas de impuestos aplicables</label>
        <div>
            @if (ViewBag.TaxRules != null)
            {
                foreach (var rule in ViewBag.TaxRules)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="reglasSeleccionadas" value="@rule.Id" id="rule_@rule.Id">
                        <label class="form-check-label" for="rule_@rule.Id">@rule.Nombre (@rule.Porcentaje.ToString("N2", CultureInfo.CurrentCulture) %)</label>
                    </div>
                }
            }
        </div>
    </div>

    <input type="submit" value="Calcular" class="btn btn-primary" />
</form>
